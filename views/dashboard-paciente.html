<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Paciente - Sistema de Risco de Saúde</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .risk-card { border-left: 4px solid; margin-bottom: 1rem; }
        .risk-alto { border-left-color: #ff3860; }
        .risk-moderado { border-left-color: #ffdd57; }
        .risk-baixo { border-left-color: #23d160; }
        .history-container { max-height: 500px; overflow-y: auto; }
        .timeline { position: relative; padding-left: 2rem; }
        .timeline::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dbdbdb;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: #3273dc;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #dbdbdb;
        }
        .progress-chart {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 1.5rem;
        }
        .stats-card {
            text-align: center;
            padding: 1.5rem;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar is-info" role="navigation">
        <div class="navbar-brand">
            <div class="navbar-item">
                <h1 class="title is-4 has-text-white">
                    <i class="fas fa-user"></i> Dashboard Paciente
                </h1>
            </div>
        </div>
        <div class="navbar-menu">
            <div class="navbar-end">
                <div class="navbar-item">
                    <span class="has-text-white" id="patientName">Paciente</span>
                </div>
                <div class="navbar-item">
                    <a href="/logout" class="button is-light">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header com resumo -->
        <div class="columns">
            <div class="column">
                <div class="box stats-card">
                    <p class="heading">Total de Avaliações</p>
                    <p class="title" id="totalAssessments">-</p>
                </div>
            </div>
            <div class="column">
                <div class="box stats-card">
                    <p class="heading">Última Avaliação</p>
                    <p class="title is-6" id="lastAssessment">-</p>
                </div>
            </div>
            <div class="column">
                <div class="box stats-card">
                    <p class="heading">Risco Atual</p>
                    <p class="title" id="currentRisk">
                        <span class="tag is-large">-</span>
                    </p>
                </div>
            </div>
            <div class="column">
                <div class="box stats-card">
                    <p class="heading">Tendência</p>
                    <p class="title" id="riskTrend">
                        <i class="fas fa-minus has-text-grey"></i>
                    </p>
                </div>
            </div>
        </div>

        <!-- Gráfico de Progressão -->
        <div class="box progress-chart">
            <h2 class="title is-4 has-text-centered">
                <i class="fas fa-chart-line"></i> Progressão do Risco
            </h2>
            <div id="progressionChart">
                <canvas id="riskChart" width="800" height="300"></canvas>
            </div>
        </div>

        <!-- Histórico Detalhado -->
        <div class="box">
            <h2 class="title is-4">
                <i class="fas fa-history"></i> Histórico Detalhado
            </h2>
            
            <div class="field has-addons">
                <div class="control is-expanded">
                    <input class="input" type="text" id="searchHistory" placeholder="Buscar por data ou risco...">
                </div>
                <div class="control">
                    <button class="button is-info" onclick="filterHistory()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div class="control">
                    <button class="button is-light" onclick="loadHistory()">
                        <i class="fas fa-refresh"></i> Atualizar
                    </button>
                </div>
            </div>

            <div class="history-container">
                <div id="historyTimeline" class="timeline">
                    <!-- Histórico será carregado aqui -->
                </div>
            </div>
        </div>

        <!-- Informações sobre Riscos -->
        <div class="box">
            <h2 class="title is-4">
                <i class="fas fa-info-circle"></i> Entenda os Níveis de Risco
            </h2>
            
            <div class="columns">
                <div class="column">
                    <div class="message is-danger">
                        <div class="message-header">
                            <p>Risco ALTO</p>
                        </div>
                        <div class="message-body">
                            <strong>Critérios:</strong> Paciente idoso (&gt;65 anos), gravemente obeso (IMC &gt; 35) e hipertenso (≥160 mmHg sistólica).
                            <br><strong>Recomendação:</strong> Procure atendimento médico imediatamente para avaliação e tratamento.
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="message is-warning">
                        <div class="message-header">
                            <p>Risco MODERADO</p>
                        </div>
                        <div class="message-body">
                            <strong>Critérios:</strong> Alguns fatores de risco presentes, mas não todos os critérios de alto risco.
                            <br><strong>Recomendação:</strong> Mantenha acompanhamento médico regular e adote hábitos saudáveis.
                        </div>
                    </div>
                </div>
                <div class="column">
                    <div class="message is-success">
                        <div class="message-header">
                            <p>Risco BAIXO</p>
                        </div>
                        <div class="message-body">
                            <strong>Critérios:</strong> Poucos ou nenhum fator de risco identificado.
                            <br><strong>Recomendação:</strong> Continue mantendo um estilo de vida saudável e check-ups preventivos.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification container -->
    <div id="notifications" class="is-fixed" style="position: fixed; top: 20px; right: 20px; z-index: 1000;"></div>

    <script>
        let currentUser = null;
        let historyData = [];
        let filteredHistory = [];
        let riskChart = null;

        // Carregar dados do usuário
        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('patientName').textContent = currentUser.nome;
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usuário:', error);
            }
        }

        // Carregar histórico do paciente
        async function loadHistory() {
            try {
                const response = await fetch('/api/historico');
                if (response.ok) {
                    historyData = await response.json();
                    filteredHistory = [...historyData];
                    displayHistory();
                    updateStats();
                    updateChart();
                } else {
                    const error = await response.json();
                    showNotification(error.error, 'is-danger');
                }
            } catch (error) {
                showNotification('Erro ao carregar histórico', 'is-danger');
            }
        }

        // Exibir histórico na timeline
        function displayHistory() {
            const container = document.getElementById('historyTimeline');
            
            if (filteredHistory.length === 0) {
                container.innerHTML = `
                    <div class="has-text-centered has-text-grey">
                        <i class="fas fa-clipboard-list fa-3x"></i>
                        <p class="mt-3">Nenhum histórico de risco encontrado.</p>
                        <p>Suas avaliações médicas aparecerão aqui.</p>
                    </div>
                `;
                return;
            }

            // Ordenar por data (mais recente primeiro)
            const sortedHistory = filteredHistory.sort((a, b) => new Date(b.data) - new Date(a.data));

            container.innerHTML = sortedHistory.map(item => `
                <div class="timeline-item">
                    <div class="box risk-card risk-${item.risco.toLowerCase()}">
                        <div class="columns is-vcentered">
                            <div class="column">
                                <h5 class="title is-5">
                                    <span class="tag ${getRiskTagClass(item.risco)}">${item.risco}</span>
                                </h5>
                                <p class="subtitle is-6">
                                    <i class="fas fa-calendar"></i> 
                                    ${new Date(item.data).toLocaleDateString('pt-BR', {
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}
                                </p>
                            </div>
                            <div class="column">
                                <div class="columns is-mobile">
                                    <div class="column">
                                        <p class="has-text-weight-semibold">Idade</p>
                                        <p>${item.idade} anos</p>
                                    </div>
                                    <div class="column">
                                        <p class="has-text-weight-semibold">IMC</p>
                                        <p>${item.imc}</p>
                                    </div>
                                    <div class="column">
                                        <p class="has-text-weight-semibold">Pressão</p>
                                        <p>${item.pressao} mmHg</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Atualizar estatísticas
        function updateStats() {
            if (historyData.length === 0) {
                document.getElementById('totalAssessments').textContent = '0';
                document.getElementById('lastAssessment').textContent = 'Nenhuma';
                document.getElementById('currentRisk').innerHTML = '<span class="tag is-large is-light">-</span>';
                document.getElementById('riskTrend').innerHTML = '<i class="fas fa-minus has-text-grey"></i>';
                return;
            }

            // Ordenar por data
            const sortedHistory = historyData.sort((a, b) => new Date(b.data) - new Date(a.data));
            const latest = sortedHistory[0];
            
            document.getElementById('totalAssessments').textContent = historyData.length;
            document.getElementById('lastAssessment').textContent = new Date(latest.data).toLocaleDateString('pt-BR');
            document.getElementById('currentRisk').innerHTML = `<span class="tag is-large ${getRiskTagClass(latest.risco)}">${latest.risco}</span>`;
            
            // Calcular tendência
            if (historyData.length >= 2) {
                const previous = sortedHistory[1];
                const trend = calculateTrend(previous.risco, latest.risco);
                document.getElementById('riskTrend').innerHTML = trend;
            }
        }

        function calculateTrend(previousRisk, currentRisk) {
            const riskValues = { 'BAIXO': 1, 'MODERADO': 2, 'ALTO': 3 };
            const prev = riskValues[previousRisk];
            const curr = riskValues[currentRisk];
            
            if (curr > prev) {
                return '<i class="fas fa-arrow-up has-text-danger"></i> Piorando';
            } else if (curr < prev) {
                return '<i class="fas fa-arrow-down has-text-success"></i> Melhorando';
            } else {
                return '<i class="fas fa-minus has-text-warning"></i> Estável';
            }
        }

        // Atualizar gráfico
        function updateChart() {
            const canvas = document.getElementById('riskChart');
            const ctx = canvas.getContext('2d');
            
            // Limpar canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (historyData.length === 0) {
                ctx.font = '20px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhum dado disponível', canvas.width / 2, canvas.height / 2);
                return;
            }

            // Ordenar por data
            const sortedHistory = historyData.sort((a, b) => new Date(a.data) - new Date(b.data));
            
            // Configurações do gráfico
            const padding = 50;
            const graphWidth = canvas.width - 2 * padding;
            const graphHeight = canvas.height - 2 * padding;
            
            // Mapear riscos para valores numéricos
            const riskValues = { 'BAIXO': 1, 'MODERADO': 2, 'ALTO': 3 };
            const points = sortedHistory.map((item, index) => ({
                x: padding + (index * graphWidth) / (sortedHistory.length - 1 || 1),
                y: padding + graphHeight - ((riskValues[item.risco] - 1) * graphHeight) / 2,
                risk: item.risco,
                date: new Date(item.data).toLocaleDateString('pt-BR')
            }));

            // Desenhar eixos
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            
            // Eixo Y
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, padding + graphHeight);
            ctx.stroke();
            
            // Eixo X
            ctx.beginPath();
            ctx.moveTo(padding, padding + graphHeight);
            ctx.lineTo(padding + graphWidth, padding + graphHeight);
            ctx.stroke();

            // Labels do eixo Y
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666';
            ctx.textAlign = 'right';
            ctx.fillText('ALTO', padding - 10, padding + 10);
            ctx.fillText('MODERADO', padding - 10, padding + graphHeight / 2);
            ctx.fillText('BAIXO', padding - 10, padding + graphHeight - 5);

            // Desenhar linha do gráfico
            if (points.length > 1) {
                ctx.strokeStyle = '#3273dc';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(points[0].x, points[0].y);
                
                for (let i = 1; i < points.length; i++) {
                    ctx.lineTo(points[i].x, points[i].y);
                }
                ctx.stroke();
            }

            // Desenhar pontos
            points.forEach(point => {
                const color = point.risk === 'ALTO' ? '#ff3860' : 
                             point.risk === 'MODERADO' ? '#ffdd57' : '#23d160';
                
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.arc(point.x, point.y, 6, 0, 2 * Math.PI);
                ctx.fill();
                
                // Border branco
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            });
        }

        // Filtrar histórico
        function filterHistory() {
            const searchTerm = document.getElementById('searchHistory').value.toLowerCase();
            
            if (!searchTerm) {
                filteredHistory = [...historyData];
            } else {
                filteredHistory = historyData.filter(item => 
                    item.risco.toLowerCase().includes(searchTerm) ||
                    new Date(item.data).toLocaleDateString('pt-BR').includes(searchTerm)
                );
            }
            
            displayHistory();
        }

        // Limpar filtro
        document.getElementById('searchHistory').addEventListener('input', function() {
            if (this.value === '') {
                filteredHistory = [...historyData];
                displayHistory();
            }
        });

        function getRiskTagClass(risco) {
            switch(risco) {
                case 'ALTO': return 'is-danger';
                case 'MODERADO': return 'is-warning';
                case 'BAIXO': return 'is-success';
                default: return 'is-light';
            }
        }

        // Função para mostrar notificações
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <button class="delete" onclick="this.parentElement.remove()"></button>
                ${message}
            `;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            loadHistory();
        });
    </script>
</body>
</html>